<!DOCTYPE html>
<html lang="en" ng-app="myapp">

<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <style>
        .container { width: 400px; margin: auto; }
        input, label, button { display: block; margin: 5px 0; }
        .item { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    </style>
</head>

<body ng-controller="formCtrl">
    <div class="container">
        <h2>User {{ user._id ? 'Update' : 'Registration' }} Form</h2>

        <form ng-submit="submit()">
            <label>Name</label>
            <input type="text" ng-model="user.name" required>

            <label>Password</label>
            <input type="password" ng-model="user.password" ng-change="checkPassword()" required>
            <h5 ng-style="textStyle">{{ passwordText }}</h5>

            <label>Email</label>
            <input type="email" ng-model="user.email" required>

            <label>DOB</label>
            <input type="date" ng-model="user.dob" required>

            <input type="submit" value="{{ user._id ? 'Update' : 'Submit' }}">
            <button type="button" ng-click="reset()" ng-show="user._id">Cancel Edit</button>
        </form>

        <hr>

        <h3>Registered Users</h3>
        <div class="item" ng-repeat="u in users track by u._id">
            <p><strong>ID:</strong> {{ u._id }}</p>
            <p><strong>Name:</strong> {{ u.name }}</p>
            <p><strong>Email:</strong> {{ u.email }}</p>
            <p><strong>DOB:</strong> {{ u.dob }}</p>

            <button ng-click="edit(u)">Edit</button>
            <button ng-click="remove(u._id)">Delete</button>
        </div>
    </div>

    <script>
        angular.module("myapp", []).controller("formCtrl", function ($scope, $http) {
            const API = 'http://localhost:3000/api/sub';
            $scope.users = [];
            $scope.user = {};
            $scope.passwordText = '';
            $scope.textStyle = {};

            function fetchUsers() {
                $http.get(API)
                    .then(res => $scope.users = res.data)
                    .catch(err => console.error("Fetch error:", err));
            }

            $scope.checkPassword = function () {
                const p = $scope.user.password || '';
                const hasUpper = /[A-Z]/.test(p);
                const hasLower = (p.match(/[a-z]/g) || []).length >= 3;
                const hasDigit = /[0-9]/.test(p);
                const hasSpecial = /[^a-zA-Z0-9]/.test(p);
                const strong = p.length >= 6 && hasUpper && hasLower && hasDigit && hasSpecial;

                $scope.passwordText = "Password strength: " + (strong ? "strong" : "weak");
                $scope.textStyle = { color: strong ? "green" : "red" };
            };

            $scope.submit = function () {
                const data = {
                    name: $scope.user.name,
                    password: $scope.user.password,
                    email: $scope.user.email,
                    dob: $scope.user.dob ? $scope.user.dob.toISOString().split('T')[0] : null
                };

                const req = $scope.user._id
                    ? $http.put(`${API}/${$scope.user._id}`, data)
                    : $http.post(API, data);

                req.then(function () {
                    $scope.reset();
                    fetchUsers();
                }).catch(function (err) {
                    console.error("Submit error:", err);
                });
            };

            $scope.edit = function (u) {
                $scope.user = {
                    _id: u._id,
                    name: u.name,
                    email: u.email,
                    dob: new Date(u.dob),
                    password: ""
                };
                $scope.passwordText = `Editing user: ${u.name}`;
                $scope.textStyle = { color: "blue" };
            };

            $scope.remove = function (id) {
                $http.delete(`${API}/${id}`)
                    .then(fetchUsers)
                    .catch(function (err) {
                        console.error("Delete error:", err);
                    });
            };

            $scope.reset = function () {
                $scope.user = {};
                $scope.passwordText = "";
                $scope.textStyle = {};
            };

            // Initial load
            fetchUsers();
        });
    </script>
</body>
</html>
